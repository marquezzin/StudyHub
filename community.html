<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="estilos/estilos-comunity.css">
    <style>@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap');</style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-3">
            <h3 class="fw-bold fs-custom text-black mb-5 text-center p-3 text-break">StudyHub</h3>
            <a href="home.html"> <i class="bi bi-house-fill"></i>  Home</a>
            <a href="calendario.html"> <i class="bi bi-calendar"></i> Calend√°rio</a>
            <a href="community.html"  class="active"> <i class="bi bi-people-fill"></i> Comunidade</a>
            <a href="assets/Briefing1.pdf"  target="_blank" rel="noopener noreferrer"> <i class="bi bi-file-text"></i> Briefing</a>
        </div>
        <div class="card-maior">
            <main class="main-content">
                <header class="main-header">
                    <h3>Ol√°, Thales!</h3>
                    <img src="Avatar/818a4a84f4e45638c2445ce365971a0a.png" alt="Avatar do usu√°rio Thales" class="user-avatar">
                </header>
                <section class="chat-feed">
                    <article class="message-bubble received" data-post-id="post-1">
                        <img src="Avatar/p_380164-119771.avif" alt="Avatar de Gabriela Lima" class="message-avatar">
                        <div class="message-content">
                            <div class="message-header"><strong>Gabriela Lima</strong><div class="message-options"><button class="options-button">...</button><div class="options-menu"><button class="delete-button">Deletar</button></div></div></div>
                            <p class="message-text">Eu gostaria de focar mais nos meus estudos, dicas?</p>
                            <div class="message-footer">
                                <button class="like-button"><i class="bi bi-heart"></i> <span class="like-count">20</span></button>
                                <button class="comment-button"><i class="bi bi-chat"></i> <span class="comment-count">2</span></button>
                            </div>
                        </div>
                    </article>
    
                     <article class="message-bubble received" data-post-id="post-2">
                        <img src="Avatar/pe380164-121867.avif" alt="Avatar de Laura Peixoto" class="message-avatar">
                        <div class="message-content">
                            <div class="message-header"><strong>Laura Peixoto</strong><div class="message-options"><button class="options-button">...</button><div class="options-menu"><button class="delete-button">Deletar</button></div></div></div>
                            <p class="message-text">Algu√©m fez resumo do projeto de POO??? T√¥ desesperada</p>
                            <div class="message-footer">
                               <button class="like-button"><i class="bi bi-heart"></i> <span class="like-count">13</span></button>
                               <button class="comment-button"><i class="bi bi-chat"></i> <span class="comment-count">1</span></button>
                            </div>
                        </div>
                    </article>
    
                    <article class="message-bubble sent" data-post-id="post-3">
                         <div class="message-content">
                             <div class="message-header"><strong>Thales Rassi</strong><div class="message-options"><button class="options-button">...</button><div class="options-menu"><button class="delete-button">Deletar</button></div></div></div>
                             <p class="message-text">Gente n√£o esque√ßam da prova segunda!!</p>
                             <div class="message-footer">
                                <button class="like-button"><i class="bi bi-heart"></i> <span class="like-count">78</span></button>
                                <button class="comment-button"><i class="bi bi-chat"></i> <span class="comment-count">0</span></button>
                             </div>
                         </div>
                         <img src="Avatar/818a4a84f4e45638c2445ce365971a0a.png" alt="Avatar de Thales" class="message-avatar">
                    </article>
                </section>
                <footer class="chat-input-area">
                    <form class="message-form">
                        <input type="text" placeholder="Escreva Aqui..." autocomplete="off">
                        <button type="submit" class="icon-button">‚û§</button>
                    </form>
                </footer>
            </main>
        </div>
        
    </div>
    <aside class="comments-drawer"></aside>

    <script>
        // 1. DEFINI√á√ÉO DOS AVATARES DOS USU√ÅRIOS
        const userAvatars = {
            thales: 'Avatar/818a4a84f4e45638c2445ce365971a0a.png',
            gabriela: 'Avatar/p_380164-119771.avif',
            laura: 'Avatar/pe380164-121867.avif',
            matheus: 'Avatar/33adr34.jpg'
        };

        /* BLOCO 1: SELETORES DE ELEMENTOS E CONSTANTES GLOBAIS */
        const chatFeed = document.querySelector('.chat-feed');
        const messageForm = document.querySelector('.message-form');
        const messageInput = messageForm.querySelector('input');
        const commentsDrawer = document.querySelector('.comments-drawer');

        /* BLOCO 2: ESTADO DA APLICA√á√ÉO */
        const currentUser = {
            name: 'Thales Rassi',
            avatar: userAvatars.thales
        };

        let commentsData = {
            "post-1": [
                { id: `reply-${Date.now() + 1}`, user: "Thales Rassi", avatar: userAvatars.thales, text: "T√©cnica Pomodoro! Estude por 25 minutos e descanse 5. Ajuda muito a manter o foco." },
                { id: `reply-${Date.now() + 2}`, user: "Laura Peixoto", avatar: userAvatars.laura, text: "Verdade, @Thales! Eu tamb√©m uso e funciona demais." },
            ],
            "post-2": [
                { id: `reply-${Date.now() + 3}`, user: "Matheus Souza", avatar: userAvatars.matheus, text: "Opa, eu tenho um resumo sim, te mando no privado!" }
            ],
            "post-3": []
        };
        
        /* BLOCO 3: FUN√á√ïES DE RENDERIZA√á√ÉO */

        function createSentMessageHTML(text) {
            const postId = `post-${Date.now()}`;
            return `
                <article class="message-bubble sent" data-post-id="${postId}">
                    <div class="message-content">
                        <div class="message-header"><strong>${currentUser.name}</strong><div class="message-options"><button class="options-button">...</button><div class="options-menu"><button class="delete-button">Deletar</button></div></div></div>
                        <p class="message-text">${text}</p>
                        <div class="message-footer">
                           <button class="like-button">‚ô° <span class="like-count">0</span></button>
                           <button class="comment-button">üí¨ <span class="comment-count">0</span></button>
                        </div>
                    </div>
                    <img src="${currentUser.avatar}" alt="Avatar de ${currentUser.name}" class="message-avatar">
                </article>`;
        }

        function createReplyHTML(reply) {
            const isSentByCurrentUser = (reply.user === currentUser.name);
            const bubbleClass = isSentByCurrentUser ? 'sent' : 'received';
            
            const optionsMenuHTML = isSentByCurrentUser ? `
                <div class="message-options">
                    <button class="options-button">...</button>
                    <div class="options-menu">
                        <button class="delete-button">Deletar</button>
                    </div>
                </div>
            ` : '';
            
            const avatarHTML = `<img src="${reply.avatar}" alt="Avatar de ${reply.user}" class="message-avatar">`;
            
            const articleContent = `
                   <div class="message-content">
                     <div class="message-header">
                         <strong>${reply.user}</strong>
                         ${optionsMenuHTML}
                     </div>
                     <p class="message-text">${reply.text}</p>
                   </div>
            `;

            if (isSentByCurrentUser) {
                return `<article class="message-bubble ${bubbleClass}" data-reply-id="${reply.id}">${articleContent}${avatarHTML}</article>`;
            }
            return `<article class="message-bubble ${bubbleClass}" data-reply-id="${reply.id}">${avatarHTML}${articleContent}</article>`;
        }


        function renderCommentsDrawer(postId) {
            const postElement = chatFeed.querySelector(`[data-post-id="${postId}"]`);
            if (!postElement) return;

            const postHTML = postElement.outerHTML;
            const replies = commentsData[postId] || [];
            let repliesHTML = replies.map(createReplyHTML).join('');

            commentsDrawer.innerHTML = `
                <div class="drawer-header"><h3>Coment√°rios</h3><button class="close-drawer-button">√ó</button></div>
                <div class="drawer-content">
                    <div class="original-post-container">${postHTML}</div>
                    <div class="replies-list">${repliesHTML}</div>
                </div>
                <div class="drawer-footer">
                    <form class="message-form reply-form" data-post-id="${postId}">
                        <input type="text" placeholder="Escreva uma resposta..." autocomplete="off">
                        <button type="submit" class="icon-button">‚û§</button>
                    </form>
                </div>`;
            
            const postInsideDrawer = commentsDrawer.querySelector('.original-post-container .message-bubble');
            postInsideDrawer.querySelector('.like-button')?.setAttribute('disabled', true);
            postInsideDrawer.querySelector('.comment-button')?.setAttribute('disabled', true);
            
            commentsDrawer.classList.add('visible');
        }

        /* BLOCO 4: MANIPULADORES DE EVENTOS */

        function handleMainFormSubmit(event) {
            event.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText === '') return;
            const newMessageHTML = createSentMessageHTML(messageText);
            chatFeed.insertAdjacentHTML('beforeend', newMessageHTML);
            messageInput.value = '';
            chatFeed.scrollTop = chatFeed.scrollHeight;
            messageInput.focus();
        }

        function handleChatFeedClick(event) {
            const target = event.target;

            const likeButton = target.closest('.like-button');
            if (likeButton) {
                const countSpan = likeButton.querySelector('.like-count');
                let currentCount = parseInt(countSpan.textContent);
                likeButton.classList.toggle('liked');
                currentCount += likeButton.classList.contains('liked') ? 1 : -1;
                countSpan.textContent = currentCount;
                return; 
            }

            const optionsButton = target.closest('.options-button');
            if (optionsButton) {
                const menu = optionsButton.nextElementSibling;
                document.querySelectorAll('.options-menu.visible').forEach(openMenu => {
                    if (openMenu !== menu) openMenu.classList.remove('visible');
                });
                menu.classList.toggle('visible');
                return; 
            }

            const deleteButton = target.closest('.delete-button');
            if (deleteButton) {
                const messageToDelete = deleteButton.closest('.message-bubble');
                if (messageToDelete) {
                    const postId = messageToDelete.dataset.postId;
                    delete commentsData[postId];
                    messageToDelete.remove();
                }
                return;
            }

            const commentButton = target.closest('.comment-button');
            if (commentButton) {
                const postId = commentButton.closest('.message-bubble').dataset.postId;
                renderCommentsDrawer(postId);
                return;
            }
        }

        function handleDrawerClick(event) {
            const target = event.target;

            if (target.closest('.close-drawer-button')) {
                commentsDrawer.classList.remove('visible');
                return;
            }
            
            const mainDeleteButton = target.closest('.original-post-container .delete-button');
            if (mainDeleteButton) {
                const postInDrawer = mainDeleteButton.closest('.message-bubble');
                const postId = postInDrawer.dataset.postId;
                const postInFeed = chatFeed.querySelector(`.message-bubble[data-post-id="${postId}"]`);
                postInFeed?.remove();
                delete commentsData[postId];
                commentsDrawer.classList.remove('visible');
                return;
            }

            const replyOptionsButton = target.closest('.replies-list .options-button');
            if (replyOptionsButton) {
                const menu = replyOptionsButton.nextElementSibling;
                commentsDrawer.querySelectorAll('.options-menu.visible').forEach(openMenu => {
                    if (openMenu !== menu) openMenu.classList.remove('visible');
                });
                menu.classList.toggle('visible');
                return;
            }
            
            const replyDeleteButton = target.closest('.replies-list .delete-button');
            if (replyDeleteButton) {
                const replyBubble = replyDeleteButton.closest('.message-bubble');
                const replyIdToDelete = replyBubble.dataset.replyId;
                const postId = commentsDrawer.querySelector('.reply-form').dataset.postId;

                if (commentsData[postId] && replyIdToDelete) {
                    commentsData[postId] = commentsData[postId].filter(reply => reply.id !== replyIdToDelete);
                }

                replyBubble.remove();
                
                const commentCountSpan = chatFeed.querySelector(`.message-bubble[data-post-id="${postId}"] .comment-count`);
                if (commentCountSpan) {
                    commentCountSpan.textContent = commentsData[postId]?.length || 0;
                }
                return;
            }
        }

        function handleDrawerSubmit(event) {
            event.preventDefault();
            if (!event.target.classList.contains('reply-form')) return;

            const replyInput = event.target.querySelector('input');
            const replyText = replyInput.value.trim();
            const postId = event.target.dataset.postId;

            if (replyText === '') return;

            const newReplyData = {
                id: `reply-${Date.now()}`,
                user: currentUser.name,
                avatar: currentUser.avatar,
                text: replyText
            };
            
            commentsData[postId] = commentsData[postId] || [];
            commentsData[postId].push(newReplyData);
            
            const newReplyHTML = createReplyHTML(newReplyData);
            commentsDrawer.querySelector('.replies-list').insertAdjacentHTML('beforeend', newReplyHTML);
            
            const commentCountSpan = document.querySelector(`.message-bubble[data-post-id="${postId}"] .comment-count`);
            if (commentCountSpan) {
                commentCountSpan.textContent = commentsData[postId].length;
            }

            replyInput.value = '';
            replyInput.focus();
        }

        function handleDocumentClick(event) {
            if (!event.target.closest('.message-options')) {
                document.querySelectorAll('.options-menu.visible').forEach(menu => {
                    menu.classList.remove('visible');
                });
            }
        }
        
        /* BLOCO 5: INICIALIZA√á√ÉO DA APLICA√á√ÉO */
        
        function init() {
            messageForm.addEventListener('submit', handleMainFormSubmit);
            chatFeed.addEventListener('click', handleChatFeedClick);
            commentsDrawer.addEventListener('click', handleDrawerClick);
            commentsDrawer.addEventListener('submit', handleDrawerSubmit);
            document.addEventListener('click', handleDocumentClick);
            console.log("StudyHub App inicializado com sucesso!");
        }

        init();
    </script>
</body>
</html>